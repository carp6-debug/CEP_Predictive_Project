@page "/"
@using CEP_Predictive_Dashboard.Models
@using CEP_Predictive_Dashboard.Services
@inject CEP_Predictive_Dashboard.Services.MaintenanceService MaintenanceSvc

<PageTitle>CEP Predictive Dashboard</PageTitle>

    <div class="container mt-4">
        @* Passive Header: Explains the sync logic without needing a button *@
        <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">üèóÔ∏è Construction Fleet Health</h1>
        <div class="text-end">
            <span class="badge rounded-pill bg-light text-dark border shadow-sm px-3 py-2">
                <strong>Last Updated:</strong> @DateTime.Now.ToString("MMM dd, yyyy HH:mm:ss")
            </span>
        </div>
    </div>

    @if (fleetStatus == null)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Initializing PostgreSQL Data Stream...</p>
        </div>
    }
    else
    {
        @* --- SUMMARY METRIC BAR (The 4-Card Traffic Light System) --- *@
        <div class="row mb-4 align-items-stretch">
            <div class="col-md-3 mb-3">
                <div class="card h-100 bg-dark text-white shadow-sm border-0">
                    <div class="card-body text-center p-3">
                        <h2 class="fw-bold">@fleetStatus.Count</h2>
                        <small class="text-uppercase">Total Assets</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 text-white shadow-sm border-0" style="background-color: #dc3545;">
                    <div class="card-body text-center p-3">
                        <h2 class="fw-bold">@fleetStatus.Count(a => a.StatusCode == "Critical")</h2>
                        <small class="text-uppercase">Critical Risk</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 text-white shadow-sm border-0" style="background-color: #ffc107;">
                    <div class="card-body text-center p-3">
                        <h2 class="fw-bold">@fleetStatus.Count(a => a.StatusCode == "Warning")</h2>
                        <small class="text-uppercase">Maintenance Warnings</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 text-white shadow-sm border-0" style="background-color: #198754;">
                    <div class="card-body text-center p-3">
                        <h2 class="fw-bold">@fleetStatus.Count(a => a.StatusCode == "Operational")</h2>
                        <small class="text-uppercase">Operational</small>
                    </div>
                </div>
            </div>
        </div>

        <hr class="mb-5" />

        @* --- DETAILED ASSET CARDS --- *@
        <div class="row">
            @foreach (var asset in fleetStatus)
            {
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm" style="@asset.CardStyle">
                        <div class="card-body">
                            <h5 class="card-title">@asset.AssetTag</h5>
                            <h6 class="card-subtitle mb-2 text-muted">@asset.ProjectName</h6>
                            <hr />
                            <p class="card-text">
                                <strong>Borough:</strong> @asset.Borough <br />
                                <strong>Vibration:</strong> @asset.VibrationLevel mm/s <br />
                                <strong>Status:</strong> 
                                <span class="badge bg-@asset.AlertColor">@asset.StatusCode</span>
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<AssetStatus>? fleetStatus;
    private string lastSyncTime = DateTime.Now.ToString("HH:mm:ss");

    protected override async Task OnInitializedAsync()
    {
        // Initial data fetch from PostgreSQL
        fleetStatus = await MaintenanceSvc.GetLatestFleetHealthAsync();
        lastSyncTime = DateTime.Now.ToString("HH:mm:ss");
    }
}